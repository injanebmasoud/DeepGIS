<!DOCTYPE html>
<html dir="rtl" lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>داشبورد پیش‌بینی حوادث طبیعی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
    <style>
        @font-face {
            font-family: "IRANSans";
            src: url('iransans.woff2');
        }
        * {
            font-family: "IRANSans";
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            
        }

        body {
            font-family: "IRANSans";
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f8f9fa;
        }

        .search-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 300px;
        }

        .search-box {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>') no-repeat;
            background-position: 12px center;
        }

        #map {
            flex: 1;
            width: 100%;
        }

        .ai-interface {
            position: absolute;
            top: 80px;
            right: 20px;
            z-index: 1000;
            width: 300px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 16px;
            height: 80%;
        }

        .category-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
        }

        .category-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            font-size: 13px;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-button:hover {
            background: #f5f5f5;
        }

        .category-button.active {
            background: #6e41e2;
            color: white;
            border-color: #6e41e2;
        }

        .question-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 12px;
            resize: none;
            font-size: 14px;
        }

        .attach-button {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            background: #6e41e2;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-right: auto;
        }

        .response-container {
            margin-top: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" class="search-box" placeholder="جستجو در نقشه...">
    </div>

    <div class="ai-interface">
        <div class="category-buttons" id="categoryButtons"></div>

        <textarea class="question-input" rows="3" placeholder="سوال خود را درباره این منطقه بپرسید..."></textarea>

        <button class="attach-button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            ارسال پرسش
        </button>

        <div class="response-container">
            لطفاً منطقه مورد نظر خود را روی نقشه انتخاب کنید و سپس سوال خود را بپرسید.
        </div>
    </div>

    <div id="map"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        // راه‌اندازی نقشه
        const map = L.map('map').setView([35.6892, 51.3890], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap DeepGIS'
        }).addTo(map);

        // متغیرهای مورد نیاز
        let selectedLocation = null;
        let marker = null;

        // رویداد کلیک روی نقشه
        map.on('click', function(e) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker(e.latlng).addTo(map);
            selectedLocation = e.latlng;
            
            // نمایش موقعیت انتخاب شده
            document.querySelector('.response-container').innerHTML = 
                `موقعیت انتخاب شده: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
        });

        // تعریف دسته‌بندی‌ها
        const categories = [
            { name: 'آب و هوا', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>' },
            { name: 'سیلاب', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>' },
            { name: 'آتش‌سوزی', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M2 12h20"/></svg>' },
            { name: 'معادن', icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>' }
        ];

        // ایجاد دکمه‌های دسته‌بندی
        const categoryButtonsContainer = document.getElementById('categoryButtons');
        categories.forEach((category, index) => {
            const button = document.createElement('button');
            button.className = 'category-button' + (index === 0 ? ' active' : '');
            button.innerHTML = `${category.icon} ${category.name}`;
            button.addEventListener('click', function() {
                document.querySelectorAll('.category-button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
            categoryButtonsContainer.appendChild(button);
        });

        async function sendToAI(category, location, question) {
            const responseContainer = document.querySelector('.response-container');
            responseContainer.innerHTML = 'در حال پردازش درخواست...';

            const prompt = `Category: ${category}\nLocation: ${location.lat}, ${location.lng}\nQuestion: ${question}`;

            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-goog-api-key': 'AIzaSyC_DZ3fiHwBvqeXPZRAg_ugDRee6K-EJes'
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    responseContainer.innerHTML = data.candidates[0].content.parts[0].text;
                } else {
                    responseContainer.innerHTML = 'خطا در دریافت پاسخ از هوش مصنوعی.';
                }
            } catch (error) {
                console.error('Error:', error);
                responseContainer.innerHTML = 'خطا در ارتباط با سرور هوش مصنوعی.';
            }
        }
        // رویداد ارسال پرسش
        document.querySelector('.attach-button').addEventListener('click', async function() {
            const question = document.querySelector('.question-input').value;
            if (!selectedLocation) {
                alert('لطفاً ابتدا یک منطقه را روی نقشه انتخاب کنید.');
                return;
            }
            if (!question) {
                alert('لطفاً سوال خود را وارد کنید.');
                return;
            }

            const activeCategory = document.querySelector('.category-button.active').textContent.trim();
            await sendToTalkbot(
                activeCategory,
                {
                    lat: selectedLocation.lat,
                    lng: selectedLocation.lng
                },
                question
            );
        });
    </script>
</body>
</html>
